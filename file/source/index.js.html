<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">source/index.js | mvkoa</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Node.JS back-end framework based on Koa 2 &amp; ECMAScript Decorator proposal"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="mvkoa"><meta property="twitter:description" content="Node.JS back-end framework based on Koa 2 &amp; ECMAScript Decorator proposal"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/TechQuery/MVKoa"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/source/index.js~KoaController.html">KoaController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DELETE">DELETE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GET">GET</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HEAD">HEAD</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PATCH">PATCH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-POST">POST</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PUT">PUT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-request">request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Decorator">Decorator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DecoratorDescriptor">DecoratorDescriptor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Koa">Koa</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">source/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Koa from &apos;koa&apos;;
import Router from &apos;koa-route&apos;;

import IP from &apos;internal-ip&apos;;

const route_map = new WeakMap(),
    address_map = new WeakMap(),
    body_type = {
        POST: 1,
        PUT: 1,
        PATCH: 1
    };

export default class KoaController extends Koa {
    constructor() {
        const { constructor } = super();

        const route = route_map.get(constructor);

        if (!route) return;

        for (let [type, path, schema, placement, method] of route)
            this.use(
                Router[type.toLowerCase()](
                    path,
                    this.wrap.bind(this, method, placement, schema)
                )
            );
    }

    /**
     * @private
     *
     * @param {Function} method
     * @param {String}   placement
     * @param {Function} schema
     * @param {Context}  context
     * @param {...*}     [parameter]
     */
    async wrap(method, placement, schema, context, ...parameter) {
        var data =
            context.method in body_type ? context.request.body : context.query;

        data = await method.apply(placement === &apos;static&apos; ? constructor : this, [
            context,
            ...parameter.slice(0, -1),
            schema ? new schema(data) : data,
            parameter.pop()
        ]);

        if (!(data != null)) return;

        if (context.method === &apos;POST&apos;) context.status = 201;
        else if (data === &apos;&apos;) context.status = 204;

        context.body = data;
    }

    /**
     * @type     {Object}
     * @property {String} family
     * @property {String} address
     */
    static get IPA() {
        const address = IP.v4.sync() || IP.v6.sync() || &apos;localhost&apos;;

        return {
            family: `IPv${address.includes(&apos;:&apos;) ? 6 : 4}`,
            address
        };
    }

    listen(...parameter) {
        const that = this,
            callback = parameter.splice(-1, 1)[0];

        return super.listen(...parameter, function() {
            address_map.set(
                that,
                `http://${KoaController.IPA.address}:${this.address().port}`
            );

            return callback.apply(this, arguments);
        });
    }

    /**
     * @type {?String} HTTP URL
     */
    get address() {
        return address_map.get(this);
    }
}

/**
 * @param {String}    [method=&apos;GET&apos;] - HTTP method or `ALL`
 * @param {String}    [path=&apos;/&apos;]     - https://github.com/koajs/route#readme
 * @param {?Function} schema         - Data Schema for `query` or `body`
 *
 * @return {Decorator}
 */
export function request(method = &apos;GET&apos;, path = &apos;/&apos;, schema) {
    return meta =&gt; {
        meta.finisher = Class =&gt; {
            const map = route_map.get(Class) || [];

            map.push([
                method,
                path,
                schema,
                meta.placement,
                meta.descriptor.value
            ]);

            route_map.set(Class, map);
        };
    };
}

export function HEAD(path, schema) {
    return request(&apos;HEAD&apos;, path, schema);
}

export function GET(path, schema) {
    return request(&apos;GET&apos;, path, schema);
}

export function POST(path, schema) {
    return request(&apos;POST&apos;, path, schema);
}

export function PUT(path, schema) {
    return request(&apos;PUT&apos;, path, schema);
}

export function PATCH(path, schema) {
    return request(&apos;PATCH&apos;, path, schema);
}

export function DELETE(path, schema) {
    return request(&apos;DELETE&apos;, path, schema);
}

/**
 * @typedef {Object} DecoratorDescriptor
 *
 * @property {String}                kind         - `class`, `field` or `method`
 * @property {String}                [key]        - Member name
 * @property {String}                [placement]  - `static` or `prototype`
 * @property {Object}                [descriptor] - Last parameter of `Object.defineProperty()`
 * @property {DecoratorDescriptor[]} [elements]   - Class members
 */

/**
 * @typedef {Function} Decorator
 *
 * @param {DecoratorDescriptor} meta
 *
 * @return {?DecoratorDescriptor}
 */

/**
 * @typedef {Function} Koa
 *
 * @see https://github.com/koajs/koa/blob/master/docs/api/index.md#application
 */
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
